{% extends 'viewer/base.html' %}

{% block title %}Upravit recenzi - {{ review.title }} - Hardware Portal{% endblock %}

{% block content %}
<div class="max-w-4xl mx-auto">
    <!-- Breadcrumbs -->
    <nav class="mb-6">
        <ol class="flex items-center space-x-2 text-sm text-gray-500">
            <li><a href="{% url 'profile' %}" class="hover:text-blue-600">M≈Øj profil</a></li>
            <li class="text-gray-300">/</li>
            <li><a href="{% url 'my_reviews' %}" class="hover:text-blue-600">Moje recenze</a></li>
            <li class="text-gray-300">/</li>
            <li class="text-gray-800 font-medium">Upravit recenzi</li>
        </ol>
    </nav>

    <!-- Header -->
    <div class="mb-8">
        <h1 class="text-3xl font-bold text-gray-800 mb-2">Upravit recenzi</h1>
        <p class="text-gray-600">
            √öprava recenze pro {{ component.manufacturer }} {{ component.name }}
        </p>
    </div>

    <!-- Formul√°≈ô -->
    <div class="bg-white rounded-lg shadow-lg p-6">
        <form method="POST" class="space-y-6" id="editReviewForm">
            {% csrf_token %}

            <!-- Informace o komponentƒõ -->
            <div class="bg-yellow-50 border border-yellow-200 rounded-lg p-4">
                <h3 class="font-semibold text-yellow-900 mb-2">‚úèÔ∏è Upravujete recenzi pro:</h3>
                <div class="flex items-center">
                    <div class="w-12 h-12 bg-yellow-100 rounded-lg flex items-center justify-center mr-4">
                        {% if component_type == 'processor' %}
                            <svg class="w-6 h-6 text-yellow-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 3v2m6-2v2M9 19v2m6-2v2M5 9H3m2 6H3m18-6h-2m2 6h-2M7 19h10a2 2 0 002-2V7a2 2 0 00-2-2H7a2 2 0 00-2 2v10a2 2 0 002 2zM9 9h6v6H9V9z"/>
                            </svg>
                        {% elif component_type == 'graphics_card' %}
                            <svg class="w-6 h-6 text-yellow-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 4V2a1 1 0 011-1h8a1 1 0 011 1v2h5a1 1 0 011 1v2a1 1 0 01-1 1h-1v12a2 2 0 01-2 2H5a2 2 0 01-2-2V8H2a1 1 0 01-1-1V5a1 1 0 011-1h5z"/>
                            </svg>
                        {% else %}
                            <svg class="w-6 h-6 text-yellow-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 3v2m6-2v2M9 19v2m6-2v2M5 9H3m2 6H3m18-6h-2m2 6h-2M7 19h10a2 2 0 002-2V7a2 2 0 00-2-2H7a2 2 0 00-2 2v10a2 2 0 002 2zM9 9h6v6H9V9z"/>
                            </svg>
                        {% endif %}
                    </div>
                    <div>
                        <h4 class="font-semibold text-gray-900">{{ component.manufacturer }} {{ component.name }}</h4>
                        <p class="text-sm text-gray-600">{{ component_type_display }}</p>
                        <p class="text-xs text-gray-500 mt-1">P≈Øvodnƒõ vytvo≈ôeno: {{ review.date_created|date:"j. n. Y H:i" }}</p>
                    </div>
                </div>
            </div>

            <!-- Z√°kladn√≠ informace -->
            <div class="grid md:grid-cols-2 gap-6">
                <!-- N√°zev recenze -->
                <div class="md:col-span-2">
                    <label for="{{ form.title.id_for_label }}" class="block text-sm font-medium text-gray-700 mb-2">
                        {{ form.title.label }} *
                    </label>
                    {{ form.title }}
                    {% if form.title.errors %}
                        <p class="text-red-600 text-sm mt-1">{{ form.title.errors.0 }}</p>
                    {% endif %}
                </div>

                <!-- Typ komponenty (readonly/locked) -->
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">
                        Typ komponenty
                    </label>
                    <div class="relative">
                        <input type="text"
                               value="{{ component_type_display }}"
                               class="w-full px-3 py-2 border border-gray-300 rounded-lg bg-gray-100 text-gray-600 cursor-not-allowed"
                               readonly disabled>
                        <div class="absolute inset-y-0 right-0 flex items-center pr-3">
                            <svg class="w-4 h-4 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 15v2m-6 4h12a2 2 0 002-2v-8a2 2 0 00-2-2H6a2 2 0 00-2 2v8a2 2 0 002 2zM9 12a3 3 0 116 0 3 3 0 01-6 0z"/>
                            </svg>
                        </div>
                    </div>
                    <!-- Hidden field pro actual hodnotu -->
                    {{ form.component_type.as_hidden }}
                    <p class="text-xs text-gray-500 mt-1">üîí Typ komponenty nelze u existuj√≠c√≠ recenze zmƒõnit</p>
                </div>

                <!-- Komponenta (readonly/locked) -->
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">
                        Komponenta
                    </label>
                    <div class="relative">
                        <input type="text"
                               value="{{ component.manufacturer }} {{ component.name }}"
                               class="w-full px-3 py-2 border border-gray-300 rounded-lg bg-gray-100 text-gray-600 cursor-not-allowed"
                               readonly disabled>
                        <div class="absolute inset-y-0 right-0 flex items-center pr-3">
                            <svg class="w-4 h-4 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 15v2m-6 4h12a2 2 0 002-2v-8a2 2 0 00-2-2H6a2 2 0 00-2 2v8a2 2 0 002 2zM9 12a3 3 0 116 0 3 3 0 01-6 0z"/>
                            </svg>
                        </div>
                    </div>
                    <!-- Hidden field pro actual hodnotu -->
                    {{ form.component_choice.as_hidden }}
                    <p class="text-xs text-gray-500 mt-1">üîí Komponentu nelze u existuj√≠c√≠ recenze zmƒõnit</p>
                </div>

                <!-- Hodnocen√≠ -->
                <div>
                    <label for="{{ form.rating.id_for_label }}" class="block text-sm font-medium text-gray-700 mb-2">
                        {{ form.rating.label }} *
                    </label>
                    {{ form.rating }}
                    {% if form.rating.errors %}
                        <p class="text-red-600 text-sm mt-1">{{ form.rating.errors.0 }}</p>
                    {% endif %}
                </div>

                <!-- P≈ôezd√≠vka -->
                <div>
                    <label for="{{ form.reviewer_name.id_for_label }}" class="block text-sm font-medium text-gray-700 mb-2">
                        {{ form.reviewer_name.label }} *
                    </label>
                    {{ form.reviewer_name }}
                    {% if form.reviewer_name.errors %}
                        <p class="text-red-600 text-sm mt-1">{{ form.reviewer_name.errors.0 }}</p>
                    {% endif %}
                </div>
            </div>

            <!-- Obsah recenze -->
            <div>
                <label for="{{ form.summary.id_for_label }}" class="block text-sm font-medium text-gray-700 mb-2">
                    {{ form.summary.label }} *
                </label>
                {{ form.summary }}
                {% if form.summary.errors %}
                    <p class="text-red-600 text-sm mt-1">{{ form.summary.errors.0 }}</p>
                {% endif %}
            </div>

            <div>
                <label for="{{ form.content.id_for_label }}" class="block text-sm font-medium text-gray-700 mb-2">
                    {{ form.content.label }} *
                </label>
                {{ form.content }}
                {% if form.content.errors %}
                    <p class="text-red-600 text-sm mt-1">{{ form.content.errors.0 }}</p>
                {% endif %}
            </div>

            <!-- Klady a z√°pory -->
            <div class="grid md:grid-cols-2 gap-6">
                <div>
                    <label for="{{ form.pros.id_for_label }}" class="block text-sm font-medium text-gray-700 mb-2">
                        {{ form.pros.label }}
                        <span class="text-gray-500 font-normal">(voliteln√©)</span>
                    </label>
                    {{ form.pros }}
                    {% if form.pros.errors %}
                        <p class="text-red-600 text-sm mt-1">{{ form.pros.errors.0 }}</p>
                    {% endif %}
                </div>

                <div>
                    <label for="{{ form.cons.id_for_label }}" class="block text-sm font-medium text-gray-700 mb-2">
                        {{ form.cons.label }}
                        <span class="text-gray-500 font-normal">(voliteln√©)</span>
                    </label>
                    {{ form.cons }}
                    {% if form.cons.errors %}
                        <p class="text-red-600 text-sm mt-1">{{ form.cons.errors.0 }}</p>
                    {% endif %}
                </div>
            </div>

            <!-- Tlaƒç√≠tka -->
            <div class="flex space-x-4 pt-6 border-t border-gray-200">
                <button type="submit" class="flex-1 bg-green-600 text-white py-3 px-4 rounded-lg hover:bg-green-700 transition font-medium">
                    üíæ Ulo≈æit zmƒõny
                </button>
                <a href="{% url 'my_reviews' %}" class="flex-1 bg-gray-200 text-gray-700 py-3 px-4 rounded-lg hover:bg-gray-300 transition text-center font-medium">
                    ‚ùå Zru≈°it
                </a>
            </div>
        </form>
    </div>

    <!-- Info o √∫prav√°ch -->
    <div class="bg-blue-50 border border-blue-200 rounded-lg p-4 mt-6">
        <h3 class="font-semibold text-blue-900 mb-2">‚ÑπÔ∏è Informace o √∫prav√°ch:</h3>
        <ul class="text-sm text-blue-800 space-y-1">
            <li>‚Ä¢ Posledn√≠ √∫prava: {{ review.date_updated|date:"j. n. Y H:i" }}</li>
            <li>‚Ä¢ Typ komponenty nelze zmƒõnit, pouze konkr√©tn√≠ komponentu</li>
            <li>‚Ä¢ Hlasy a koment√°≈ôe z≈Østanou zachov√°ny</li>
            <li>‚Ä¢ √öpravy jsou viditeln√© okam≈æitƒõ po ulo≈æen√≠</li>
        </ul>
    </div>
</div>

<script>
// CSRF Token helper
function getCSRFToken() {
    return document.querySelector('[name=csrfmiddlewaretoken]').value;
}

document.addEventListener('DOMContentLoaded', function() {
    // Form validation p≈ôed odesl√°n√≠m
    document.getElementById('editReviewForm').addEventListener('submit', function(e) {
        const requiredFields = [
            'id_title',
            'id_rating',
            'id_reviewer_name',
            'id_summary',
            'id_content'
        ];

        let hasErrors = false;

        requiredFields.forEach(fieldId => {
            const field = document.getElementById(fieldId);
            if (field && !field.value.trim()) {
                hasErrors = true;
                field.classList.add('border-red-500');

                // Odeber ƒçerven√Ω border po zmƒõnƒõ
                field.addEventListener('input', function() {
                    this.classList.remove('border-red-500');
                });
            }
        });

        if (hasErrors) {
            e.preventDefault();
            showMessage('Vypl≈àte pros√≠m v≈°echna povinn√° pole (oznaƒçen√° *)', 'error');

            // Scroll k prvn√≠mu chybn√©mu poli
            const firstError = document.querySelector('.border-red-500');
            if (firstError) {
                firstError.scrollIntoView({ behavior: 'smooth', block: 'center' });
                firstError.focus();
            }
        }
    });

    // Auto-resize pro textareas
    const textareas = document.querySelectorAll('textarea');
    textareas.forEach(textarea => {
        textarea.addEventListener('input', function() {
            this.style.height = 'auto';
            this.style.height = this.scrollHeight + 'px';
        });

        // Nastav initial height
        textarea.style.height = textarea.scrollHeight + 'px';
    });

    // P≈ôidej visual indik√°tor pro locked fields
    const lockedFields = document.querySelectorAll('input[readonly][disabled]');
    lockedFields.forEach(field => {
        field.parentElement.classList.add('locked-field');
    });

    console.log('Edit review form initialized - component fields are locked for security');
});

// Toast Manager
class ToastManager {
    constructor() {
        this.toasts = [];
        this.container = null;
        this.init();
    }

    init() {
        this.container = document.createElement('div');
        this.container.id = 'toast-container';
        this.container.className = 'fixed top-6 right-6 z-50 space-y-3 pointer-events-none';
        document.body.appendChild(this.container);
        this.addStyles();
    }

    show(message, type = 'info', duration = 4000) {
        const toast = this.createToast(message, type, duration);
        this.container.appendChild(toast);
        this.toasts.push(toast);

        requestAnimationFrame(() => {
            toast.classList.remove('translate-x-full', 'opacity-0', 'scale-95');
            toast.classList.add('translate-x-0', 'opacity-100', 'scale-100');
        });

        setTimeout(() => this.hide(toast), duration);
        return toast;
    }

    createToast(message, type, duration) {
        const id = 'toast-' + Date.now() + Math.random().toString(36).substr(2, 9);

        const configs = {
            success: { bg: 'bg-gradient-to-r from-green-500 to-emerald-600', icon: '‚úì' },
            error: { bg: 'bg-gradient-to-r from-red-500 to-rose-600', icon: '‚úó' },
            warning: { bg: 'bg-gradient-to-r from-yellow-500 to-orange-500', icon: '‚ö†' },
            info: { bg: 'bg-gradient-to-r from-blue-500 to-indigo-600', icon: '‚Ñπ' }
        };

        const config = configs[type] || configs.info;

        const toast = document.createElement('div');
        toast.id = id;
        toast.className = 'toast-item pointer-events-auto max-w-sm w-full transform translate-x-full opacity-0 scale-95 transition-all duration-500 ease-out';

        toast.innerHTML = `
            <div class="${config.bg} text-white rounded-xl shadow-2xl overflow-hidden">
                <div class="p-4">
                    <div class="flex items-start">
                        <div class="flex-shrink-0 mt-0.5 text-lg">
                            ${config.icon}
                        </div>
                        <div class="ml-3 flex-1">
                            <p class="text-sm font-medium leading-5">${message}</p>
                        </div>
                        <div class="ml-4 flex-shrink-0">
                            <button onclick="toastManager.hide(document.getElementById('${id}'))"
                                    class="inline-flex text-white/70 hover:text-white focus:outline-none transition-colors p-1 rounded-md hover:bg-white/10">
                                ‚úï
                            </button>
                        </div>
                    </div>
                </div>
                <div class="h-1 bg-black/20">
                    <div class="toast-progress h-1 bg-white/30 transition-all ease-linear"
                         style="width: 100%; animation: shrinkBar ${duration}ms linear forwards;"></div>
                </div>
            </div>
        `;

        return toast;
    }

    hide(toast) {
        if (!toast || !document.body.contains(toast)) return;

        toast.classList.remove('translate-x-0', 'opacity-100', 'scale-100');
        toast.classList.add('translate-x-full', 'opacity-0', 'scale-95');

        setTimeout(() => {
            this.toasts = this.toasts.filter(t => t !== toast);
            if (toast.parentNode) {
                toast.parentNode.removeChild(toast);
            }
        }, 500);
    }

    addStyles() {
        if (document.getElementById('ultra-toast-styles')) return;

        const styles = document.createElement('style');
        styles.id = 'ultra-toast-styles';
        styles.textContent = `
            @keyframes shrinkBar {
                from { width: 100%; }
                to { width: 0%; }
            }
            .toast-item:hover {
                transform: translateX(0) translateY(-2px) scale(1.02);
                box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.4);
            }
            @media (max-width: 640px) {
                #toast-container { right: 1rem; left: 1rem; }
                .toast-item { max-width: none; }
            }
            .locked-field {
                position: relative;
            }
            .locked-field::after {
                content: '';
                position: absolute;
                top: 0;
                left: 0;
                right: 0;
                bottom: 0;
                background: linear-gradient(45deg, transparent 40%, rgba(156, 163, 175, 0.1) 50%, transparent 60%);
                pointer-events: none;
                border-radius: 0.5rem;
            }
        `;

        document.head.appendChild(styles);
    }
}

// Vytvo≈ô glob√°ln√≠ instanci
const toastManager = new ToastManager();

function showMessage(message, type = 'info', duration = 4000) {
    return toastManager.show(message, type, duration);
}
</script>

{% endblock %}

