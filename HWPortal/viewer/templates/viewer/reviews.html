{% extends 'viewer/base.html' %}

{% block title %}Recenze - Hardware Portal{% endblock %}

{% block content %}
<!-- CSRF Token pro AJAX -->
{% csrf_token %}

<!-- Header -->
<div class="mb-8">
    <h1 class="text-3xl font-bold text-gray-800 mb-2">Recenze komponent</h1>
    <p class="text-gray-600">Přečtěte si recenze od našich uživatelů a podělte se o svou vlastní zkušenost</p>

    <!-- Stats Overview -->
    {% if stats %}
    <div class="grid grid-cols-2 md:grid-cols-4 gap-4 mt-6">
        <div class="bg-white rounded-lg p-4 shadow-sm">
            <div class="text-2xl font-bold text-blue-600">{{ stats.total_reviews }}</div>
            <div class="text-sm text-gray-600">Celkem recenzí</div>
        </div>
        <div class="bg-white rounded-lg p-4 shadow-sm">
            <div class="text-2xl font-bold text-green-600">{{ stats.avg_rating|floatformat:1 }}</div>
            <div class="text-sm text-gray-600">Průměrné hodnocení</div>
        </div>
        <div class="bg-white rounded-lg p-4 shadow-sm">
            <div class="text-2xl font-bold text-purple-600">{{ stats.categories_count.processor }}</div>
            <div class="text-sm text-gray-600">Recenzí procesorů</div>
        </div>
        <div class="bg-white rounded-lg p-4 shadow-sm">
            <div class="text-2xl font-bold text-orange-600">{{ stats.categories_count.graphics_card }}</div>
            <div class="text-sm text-gray-600">Recenzí GPU</div>
        </div>
    </div>
    {% endif %}
</div>

<!-- Filters and Controls -->
<div class="bg-white rounded-lg shadow-md p-6 mb-8">
    <form method="GET" class="space-y-4">
        <div class="flex flex-col md:flex-row md:items-end md:justify-between gap-4">
            <div class="flex flex-col md:flex-row space-y-4 md:space-y-0 md:space-x-4 flex-1">
                <!-- Kategorie Filter -->
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Kategorie</label>
                    <select name="category" class="px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-400">
                        {% for value, label in category_choices %}
                            <option value="{{ value }}" {% if selected_category == value %}selected{% endif %}>
                                {{ label }}
                            </option>
                        {% endfor %}
                    </select>
                </div>

                <!-- Řazení -->
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Řazení</label>
                    <select name="sort" class="px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-400">
                        {% for value, label in sort_choices %}
                            <option value="{{ value }}" {% if selected_sort == value %}selected{% endif %}>
                                {{ label }}
                            </option>
                        {% endfor %}
                    </select>
                </div>
            </div>

            <div class="flex space-x-2">
                <button type="submit" class="px-6 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition">
                    Aplikovat filtry
                </button>
                <a href="{% url 'reviews' %}" class="px-6 py-2 bg-gray-200 text-gray-700 rounded-lg hover:bg-gray-300 transition">
                    Resetovat
                </a>
            </div>
        </div>
    </form>
</div>

<!-- Quick Category Buttons -->
<div class="flex flex-wrap gap-2 mb-8">
    <a href="?category=" class="px-4 py-2 {% if not selected_category %}bg-blue-600 text-white{% else %}bg-gray-200 text-gray-700 hover:bg-gray-300{% endif %} rounded-lg transition">
        Všechny
    </a>
    <a href="?category=processor" class="px-4 py-2 {% if selected_category == 'processor' %}bg-blue-600 text-white{% else %}bg-gray-200 text-gray-700 hover:bg-gray-300{% endif %} rounded-lg transition">
        Procesory ({{ stats.categories_count.processor }})
    </a>
    <a href="?category=graphics_card" class="px-4 py-2 {% if selected_category == 'graphics_card' %}bg-blue-600 text-white{% else %}bg-gray-200 text-gray-700 hover:bg-gray-300{% endif %} rounded-lg transition">
        GPU ({{ stats.categories_count.graphics_card }})
    </a>
    <a href="?category=ram" class="px-4 py-2 {% if selected_category == 'ram' %}bg-blue-600 text-white{% else %}bg-gray-200 text-gray-700 hover:bg-gray-300{% endif %} rounded-lg transition">
        Paměti ({{ stats.categories_count.ram }})
    </a>
    <a href="?category=storage" class="px-4 py-2 {% if selected_category == 'storage' %}bg-blue-600 text-white{% else %}bg-gray-200 text-gray-700 hover:bg-gray-300{% endif %} rounded-lg transition">
        Úložiště ({{ stats.categories_count.storage }})
    </a>
</div>

<!-- Reviews List -->
<div class="space-y-6">
    {% for review in reviews %}
    <div class="bg-white rounded-lg shadow-md p-6 hover:shadow-lg transition-shadow">
        <div class="flex items-start space-x-4">
            <!-- Component Icon -->
            <div class="w-20 h-20 bg-gray-100 rounded-lg flex items-center justify-center flex-shrink-0">
                {% if review.component_type == 'processor' %}
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-10 w-10 text-gray-400" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 3v2m6-2v2M9 19v2m6-2v2M5 9H3m2 6H3m18-6h-2m2 6h-2M7 19h10a2 2 0 002-2V7a2 2 0 00-2-2H7a2 2 0 00-2 2v10a2 2 0 002 2zM9 9h6v6H9V9z" />
                    </svg>
                {% elif review.component_type == 'graphics_card' %}
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-10 w-10 text-gray-400" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 4V2a1 1 0 011-1h8a1 1 0 011 1v2h5a1 1 0 011 1v2a1 1 0 01-1 1h-1v12a2 2 0 01-2 2H5a2 2 0 01-2-2V8H2a1 1 0 01-1-1V5a1 1 0 011-1h5z" />
                    </svg>
                {% elif review.component_type == 'ram' %}
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-10 w-10 text-gray-400" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 7v10c0 2.21 3.582 4 8 4s8-1.79 8-4V7M4 7c0 2.21 3.582 4 8 4s8-1.79 8-4M4 7c0-2.21 3.582-4 8-4s8 1.79 8 4" />
                    </svg>
                {% else %}
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-10 w-10 text-gray-400" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" />
                    </svg>
                {% endif %}
            </div>

            <div class="flex-1">
                <!-- Header -->
                <div class="flex items-center justify-between mb-3">
                    <div>
                        <h3 class="text-xl font-semibold text-gray-800">{{ review.component_name }}</h3>
                        <div class="flex items-center space-x-2 mt-1">
                            <span class="inline-block px-2 py-1 {{ review.icon_class }} text-xs font-medium rounded">
                                {{ review.type_display }}
                            </span>
                            <span class="text-sm text-gray-500">Recenze od uživatele</span>
                            <span class="text-sm font-medium text-gray-700">{{ review.reviewer_name }}</span>
                        </div>
                    </div>
                    <div class="text-right">
                        <div class="flex items-center space-x-1 mb-1">
                            <div class="flex text-yellow-400 text-lg">
                                {% for i in "12345" %}
                                    {% if forloop.counter <= review.rating %}
                                        <span>★</span>
                                    {% else %}
                                        <span>☆</span>
                                    {% endif %}
                                {% endfor %}
                            </div>
                            <span class="text-sm text-gray-500">{{ review.rating }}/5</span>
                        </div>
                        <span class="text-sm text-gray-500">{{ review.date_created|date:"j. F Y" }}</span>
                    </div>
                </div>

                <!-- Review Content -->
                <div class="mb-4">
                    <h4 class="font-semibold text-gray-800 mb-2">{{ review.title }}</h4>
                    <p class="text-gray-700 leading-relaxed">
                        {{ review.summary|truncatechars:300 }}
                    </p>
                    {% if review.content|length > 300 %}
                        <button class="text-blue-600 hover:underline text-sm mt-2" onclick="toggleContent({{ review.id }})">
                            Zobrazit více →
                        </button>
                        <div id="content-{{ review.id }}" class="hidden mt-3 text-gray-700">
                            {{ review.content|linebreaks }}
                        </div>
                    {% endif %}
                </div>

                <!-- Pros and Cons -->
                {% if review.pros_list or review.cons_list %}
                <div class="flex flex-wrap gap-4 mb-4">
                    {% if review.pros_list %}
                    <div class="flex items-start space-x-2">
                        <span class="text-sm text-gray-600 mt-1">👍 Klady:</span>
                        <div class="flex flex-wrap gap-1">
                            {% for pro in review.pros_list %}
                                <span class="text-sm bg-green-100 text-green-800 px-2 py-1 rounded">{{ pro }}</span>
                            {% endfor %}
                        </div>
                    </div>
                    {% endif %}

                    {% if review.cons_list %}
                    <div class="flex items-start space-x-2">
                        <span class="text-sm text-gray-600 mt-1">👎 Zápory:</span>
                        <div class="flex flex-wrap gap-1">
                            {% for con in review.cons_list %}
                                <span class="text-sm bg-red-100 text-red-800 px-2 py-1 rounded">{{ con }}</span>
                            {% endfor %}
                        </div>
                    </div>
                    {% endif %}
                </div>
                {% endif %}

                <!-- Actions -->
                <div class="flex items-center justify-between pt-4 border-t border-gray-200">
                    <div class="flex items-center space-x-4">
                        <button class="flex items-center space-x-1 text-gray-600 hover:text-blue-600 transition" onclick="voteHelpful({{ review.id }}, true)">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M14 10h4.764a2 2 0 011.789 2.894l-3.5 7A2 2 0 0115.263 21h-4.017c-.163 0-.326-.02-.485-.06L7 20m7-10V5a2 2 0 00-2-2h-.095c-.5 0-.905.405-.905.905 0 .714-.211 1.412-.608 2.006L9 6v4m-2 4h1.096c.142 0 .284.021.42.06L12 12m-2 4v4h6v-4" />
                            </svg>
                            <span class="text-sm">Užitečné ({{ review.helpful_votes }})</span>
                        </button>
                        <button class="flex items-center space-x-1 text-gray-600 hover:text-red-600 transition" onclick="voteHelpful({{ review.id }}, false)">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 14H5.236a2 2 0 01-1.789-2.894l3.5-7A2 2 0 018.737 3h4.018c.163 0 .326.02.485.06L17 4m-7 10v2a2 2 0 002 2h.095c.5 0 .905-.405.905-.905 0-.714.211-1.412.608-2.006L15 18v-4m-4-4h-1.096c-.142 0-.284-.021-.42-.06L12 12m2-4v-4H8v4" />
                            </svg>
                            <span class="text-sm">Neužitečné ({{ review.total_votes|add:"-"|add:review.helpful_votes }})</span>
                        </button>
                    </div>
                    {% if review.component %}
                        <a href="{% url 'component_detail' review.component_type review.component.id %}" class="text-sm text-blue-600 hover:underline">
                            Zobrazit komponentu →
                        </a>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>
    {% empty %}
    <!-- No Reviews Found -->
    <div class="bg-white rounded-lg shadow-md p-12 text-center">
        <div class="w-16 h-16 bg-gray-100 rounded-full flex items-center justify-center mx-auto mb-4">
            <svg xmlns="http://www.w3.org/2000/svg" class="h-8 w-8 text-gray-400" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 8h10M7 12h4m1 8l-4-4H5a2 2 0 01-2-2V6a2 2 0 012-2h14a2 2 0 012 2v8a2 2 0 01-2 2h-3l-4 4z"/>
            </svg>
        </div>
        <h3 class="text-lg font-medium text-gray-900 mb-2">Žádné recenze nenalezeny</h3>
        <p class="text-gray-500 mb-4">
            {% if selected_category %}
                Zkuste změnit kategorii nebo resetovat filtry.
            {% else %}
                Zatím nejsou žádné recenze. Buďte první, kdo přidá hodnocení!
            {% endif %}
        </p>
        <a href="{% url 'components' %}" class="inline-block px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition">
            Prohlédnout komponenty
        </a>
    </div>
    {% endfor %}
</div>

<!-- Pagination -->
{% if reviews.has_other_pages %}
<div class="flex justify-center items-center space-x-4 mt-12">
    {% if reviews.has_previous %}
        <a href="?page={{ reviews.previous_page_number }}&category={{ selected_category }}&sort={{ selected_sort }}"
           class="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition">
            ← Předchozí
        </a>
    {% endif %}

    <div class="flex space-x-2">
        {% for num in reviews.paginator.page_range %}
            {% if reviews.number == num %}
                <span class="px-4 py-2 bg-blue-600 text-white rounded-lg">{{ num }}</span>
            {% elif num > reviews.number|add:'-3' and num < reviews.number|add:'3' %}
                <a href="?page={{ num }}&category={{ selected_category }}&sort={{ selected_sort }}"
                   class="px-4 py-2 bg-gray-200 text-gray-700 rounded-lg hover:bg-gray-300 transition">{{ num }}</a>
            {% endif %}
        {% endfor %}
    </div>

    {% if reviews.has_next %}
        <a href="?page={{ reviews.next_page_number }}&category={{ selected_category }}&sort={{ selected_sort }}"
           class="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition">
            Další →
        </a>
    {% endif %}
</div>
{% endif %}

<script>
function toggleContent(reviewId) {
    const content = document.getElementById('content-' + reviewId);
    const button = event.target;

    if (content.classList.contains('hidden')) {
        content.classList.remove('hidden');
        button.textContent = 'Zobrazit méně ↑';
    } else {
        content.classList.add('hidden');
        button.textContent = 'Zobrazit více →';
    }
}

// CSRF Token helper
function getCSRFToken() {
    return document.querySelector('[name=csrfmiddlewaretoken]').value;
}

// AJAX Voting Function
function voteHelpful(reviewId, isHelpful) {
    // Zkontroluj jestli je uživatel přihlášený
    {% if not user.is_authenticated %}
        alert('Pro hlasování se musíte přihlásit!');
        window.location.href = "{% url 'login' %}";
        return;
    {% endif %}

    // Najdi tlačítka pro vizuální feedback
    const helpfulBtn = document.querySelector(`[onclick="voteHelpful(${reviewId}, true)"]`);
    const unhelpfulBtn = document.querySelector(`[onclick="voteHelpful(${reviewId}, false)"]`);

    // Disable tlačítka během požadavku
    helpfulBtn.disabled = true;
    unhelpfulBtn.disabled = true;
    helpfulBtn.style.opacity = '0.5';
    unhelpfulBtn.style.opacity = '0.5';

    // AJAX požadavek
    fetch('{% url "vote_review_ajax" %}', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': getCSRFToken()
        },
        body: JSON.stringify({
            review_id: reviewId,
            is_helpful: isHelpful
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            // Aktualizuj počítadla
            helpfulBtn.querySelector('span').textContent = `Užitečné (${data.helpful_votes})`;
            unhelpfulBtn.querySelector('span').textContent = `Neužitečné (${data.unhelpful_votes})`;

            // Vizuální indikace hlasu uživatele
            helpfulBtn.classList.remove('text-blue-600', 'text-gray-600');
            unhelpfulBtn.classList.remove('text-red-600', 'text-gray-600');

            if (data.user_vote === true) {
                // Uživatel hlasoval helpful
                helpfulBtn.classList.add('text-blue-600');
                unhelpfulBtn.classList.add('text-gray-600');
            } else if (data.user_vote === false) {
                // Uživatel hlasoval unhelpful
                helpfulBtn.classList.add('text-gray-600');
                unhelpfulBtn.classList.add('text-red-600');
            } else {
                // Žádný hlas
                helpfulBtn.classList.add('text-gray-600');
                unhelpfulBtn.classList.add('text-gray-600');
            }

            // Zobraz zprávu
            showMessage(data.message, 'success');
        } else {
            showMessage(data.error || 'Došlo k chybě při hlasování', 'error');
        }
    })
    .catch(error => {
        console.error('Error:', error);
        showMessage('Došlo k chybě při hlasování', 'error');
    })
    .finally(() => {
        // Re-enable tlačítka
        helpfulBtn.disabled = false;
        unhelpfulBtn.disabled = false;
        helpfulBtn.style.opacity = '1';
        unhelpfulBtn.style.opacity = '1';
    });
}

// Message toast helper
function showMessage(message, type) {
    const toast = document.createElement('div');
    toast.className = `fixed top-4 right-4 px-6 py-3 rounded-lg text-white z-50 transition-opacity duration-300 ${
        type === 'success' ? 'bg-green-600' : 'bg-red-600'
    }`;
    toast.textContent = message;

    document.body.appendChild(toast);

    setTimeout(() => {
        toast.style.opacity = '0';
        setTimeout(() => document.body.removeChild(toast), 300);
    }, 3000);
}
</script>

{% endblock %}